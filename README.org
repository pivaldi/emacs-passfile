#+title: Emacs PassFile

This very simple Emacs package allows to view and edit securely a GnuPG encrypted file.

* Why this Package?

Take a look at the non encrypted file [[secret.txt]], the file ~secret.gpg~ is his GnuPG encrypted version.\\
You can for sure open the ~.gpg~ file with your Emacs evilly tuned with hundred of packages, but
you risk to open your secret file with malicious code embedded in packages that
are automatically downloaded and installed.

In order to prevent this, the purpose of this package is to open your secret
file in a *minimalist Emacs configuration* that *hide the text you want and provide a set of functions to generate strong password*.

The secret file does not follows any structured design, you write what you want like you want.

** Without ~emacs-passfile~
#+html: <p align="center"><img src="secret-txt.png" /></p>
** With ~emacs-passfile~
#+html: <p align="center"><img src="secret.png" /></p>

* Let it a try

#+BEGIN_SRC bash
cd WHERE_YOU_WANT
git clone https://github.com/pivaldi/emacs-passfile
emacs --init-directory=WHERE_YOU_WANT/emacs-passfile/ WHERE_YOU_WANT/emacs-passfile/secret.gpg
#+END_SRC

The password is ~plop~.

For my part I created a script that opens my favorite encrypted file:
#+BEGIN_SRC bash
#!/usr/bin/env bash

emacs --init-directory="$HOME/src/emacs/emacs-passfile/" "$HOME/secret.gpg"
#+END_SRC

* Hiding Content
** Hiding Password
- ~pwd: xxxxxxxxxx~ : hide the ~xxxxxxxxxx~ but stop on a space. Useful on one-line content
- ~password: xxxxx xxxxx~ : hide the ~xxxxx xxxxx~ and does not stop on any character. Can not be mixed with other content.

**  Hiding Username
- ~user: xxxxxxxxxx~ : hide the ~xxxxxxxxxx~ but stop on a space. Useful on one-line content
- ~username: xxxxx xxxxx~ : hide the ~xxxxx xxxxx~ and does not stop on any character. Can not be mixed with other content.
- ~[xxxxxxxxxx]~ : hide the ~xxxxxxxxxx~ but only one block surrounded by brackets can b used by line because of clobbering.

** Hidding Paragraph
A whole paragraph can be hidden whit the block delimiter ~#+hidden~ and  ~#-hidden~ like this:
#+BEGIN_SRC
#+hidden
…content…
#-hidden
#+END_SRC

* Generate Password

This package use [[https://github.com/vandrlexay/emacs-password-genarator][password-generator]] to provides useful functions in order to generate passwords :
- ~epf-password-generate~: generate a password for paranoiac.
- ~password-generator-simple~: minimal viable password for most of web systems.  It is not secure but allow to register.
- ~password-generator-strong~: the best password you can get.  Some symbols does not included to make you free from problems which occurs when your shell try interpolate $, \ and others.
- ~password-generator-numeric~: use numeric passwords like credit card PIN-code.
- ~password-generator-phonetic~: easy to remeber, because of fonetic, but not so secure…

* Dependencies

This packages have two dependencies:
- [[https://github.com/vandrlexay/emacs-password-genarator][password-generator]]: provides simple functions to create passwords and insert them inside buffer immediately.\\
  ~emacs-passfile~ provides the function ~epf-password-generate~, a wrapper of ~-password-generator-paranoid~.
- [[https://github.com/jekor/hidepw][hidepw]]: minor mode for hiding passwords. It’s useful if you view your passwords in Emacs and want to prevent shoulder surfing.

* Customization & Configuration
** hidepw
- ~emacs-passfile~ use this configuration :
  #+BEGIN_SRC
    (setq hidepw-patterns
          '("#\\+hidden\n\\([^]*?\\)\n#-hidden$"
            " \\[\\(.+\\)\\] ?"
            "^\\[\\(.+\\)\\] ?"
            "[pP]wd[  ]?: \\([^ \n]+\\)"
            "[pP]assword[  ]?: \\(.+\\)$"
            "[uU]ser[  ]?: \\([^ \n]+\\)"
            "[uU]sername[  ]?: \\(.+\\)"))
  #+END_SRC
- You can customize the variable ~hidepw-patterns~ of the package [[https://github.com/jekor/hidepw][hidepw]] with the ~customize-variable~ command.
- See ~M-x customize-group [RET]hidepw[RET]~ for further customization.
** Emacs configuration
For convenience, you can add your own Emacs configuration in the personal file
~configure.el~ but remember that it is not recommended to install external
packages.

Here my personal configuration:

#+BEGIN_SRC lisp
;;; configure.el --- My personnal configuration -*- lexical-binding: t; -*-
;;
;;; Commentary:
;;; Code:

(delete-selection-mode 1)
(show-paren-mode 1)

(require 'skeleton)
(setq skeleton-pair t)

;;;###autoload
(defun epf-kill-window-and-buffer()
  "Delete current window and buffer."
  (interactive)
  (kill-current-buffer)
  (condition-case nil (delete-window) (error nil)))
(global-set-key [f12] #'epf-kill-window-and-buffer)

;;;###autoload
(defun epf-new-login()
  "Insert a new login entry : Username:… Pwd:…."
  (interactive)
  (let ((user (read-from-minibuffer "Username: ")))
    (insert (format "Username: %s\nPwd: %s\n" user (epf-password-generate nil t)))))

;;;###autoload
(defun epf-scroll-up()
  "Scroll up keeping the cursor on the same line."
  (interactive)
  (let ((scroll-preserve-screen-position t))
    (scroll-up 1)))

;;;###autoload
(defun epf-scroll-down()
  "Scroll down keeping the cursor on the same line."
  (interactive)
  (let ((scroll-preserve-screen-position t))
    (scroll-down 1)))

(global-set-key (kbd "C-c p") #'epf-password-generate)
(global-set-key (kbd "C-M-<prior>") #'move-beginning-of-line)
(global-set-key (kbd "C-M-<next>") #'move-end-of-line)
(global-set-key (kbd "C-<prior>") (lambda nil (interactive) (other-window -1 nil)))
(global-set-key (kbd "C-<next>") (lambda nil (interactive) (other-window 1 nil)))
(global-set-key (kbd "C-c l") #'epf-new-login)
(global-set-key (kbd "C-M-<down>") #'epf-scroll-down)
(global-set-key (kbd "C-M-<up>") #'epf-scroll-up)
(global-set-key (kbd "C-:") 'undo-redo)
(global-set-key "\{" 'skeleton-pair-insert-maybe)
(global-set-key "\(" 'skeleton-pair-insert-maybe)
(global-set-key "[" 'skeleton-pair-insert-maybe)
(global-set-key "\"" 'skeleton-pair-insert-maybe)
(global-set-key "'" 'skeleton-pair-insert-maybe)

(provide 'configure)
;;; configure.el ends here
#+END_SRC
